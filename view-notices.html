const express = require("express");
const cors = require("cors");
const fs = require("fs");
const path = require("path");

const app = express();
const PORT = process.env.PORT || 10000;

app.use(cors());
app.use(express.json());

const DATA_FILE = path.join(__dirname, "notices.json");

/* Ensure notices.json exists */
if (!fs.existsSync(DATA_FILE)) {
  fs.writeFileSync(DATA_FILE, "[]", "utf8");
}

/* Helpers */
const readNotices = () =>
  JSON.parse(fs.readFileSync(DATA_FILE, "utf8"));

const writeNotices = (data) =>
  fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2));

/* Home check */
app.get("/", (req, res) => {
  res.send(`
    <h1>ğŸ“¢ Smart Notice Board Backend</h1>
    <p>Status: Running âœ…</p>
  `);
});

/* GET all notices */
app.get("/notices", (req, res) => {
  res.json(readNotices());
});

/* POST new notice */
app.post("/notices", (req, res) => {
  const notices = readNotices();

  const newNotice = {
    id: Date.now(),
    ...req.body
  };

  notices.push(newNotice);
  writeNotices(notices);

  res.json({ message: "Notice saved", notice: newNotice });
});

/* âœ… DELETE notice by ID */
app.delete("/notices/:id", (req, res) => {
  const id = Number(req.params.id);

  const notices = readNotices();
  const updated = notices.filter(n => n.id !== id);

  writeNotices(updated);

  res.json({ message: "Notice deleted" });
});

/* Start server */
app.listen(PORT, "0.0.0.0", () => {
  console.log(`ğŸš€ Server running on port ${PORT}`);
});
